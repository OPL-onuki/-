from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.edge.service import Service
import gspread
from oauth2client.service_account import ServiceAccountCredentials

def get_batch_info(driver, index):
    # バッチの詳細情報を取得
    batch_info_xpath = f'//*[@id="table_common_master"]/table/tbody/tr[{index}]/td[9]'
    batch_info_element = driver.find_element(By.XPATH, batch_info_xpath)
    return batch_info_element.text

def clear_and_update_data(worksheet, data, cell_range):
    # 指定されたセル範囲をクリア
    cell_list = worksheet.range(cell_range)
    for cell in cell_list:
        cell.value = ''
    worksheet.update_cells(cell_list)

    # 新しいデータを指定したセルに記録
    cell = worksheet.find(cell_range)
    worksheet.update_acell(cell.label, data)

def main():
    # Microsoft Edge WebDriverへのパスを指定
    driver_path = R"C:\Users\sab78\OneDrive\デスクトップ\不足分印刷\msedgedriver.exe"
    service = Service(driver_path)

    # Microsoft Edge WebDriverを初期化
    driver = webdriver.Edge(service=service)

    # URLを開く
    driver.get("http://192.168.3.20:8889/#/work/batch-management")

    # ページが読み込まれるのを待つ (必要に応じて時間を調整)
    driver.implicitly_wait(10)

    # "実行中"を含む要素をXPathで探す
    batch_elements = driver.find_elements(By.XPATH, '//*[@id="batchList"]/div/div/div/div[1]/span')

    # 実行中のバッチがない場合
    if not batch_elements:
        print("実行中のバッチは見つかりませんでした。終了します.")
    else:
        # 要素ごとに処理
        for index, batch_element in enumerate(batch_elements, start=1):
            if "実行中" in batch_element.text:
                print(f"実行中のバッチを見つけました: バッチ {index}")
                # 実行中のバッチに対応する要素をクリック
                batch_xpath = f'//*[@id="batchList"]/div[{index}]/div/div/div[2]/div[1]/div[1]/div[2]/div[1]'
                batch_element = driver.find_element(By.XPATH, batch_xpath)
                batch_element.click()

                # バッチの詳細情報を取得
                batch_info = get_batch_info(driver, index)

                # Google Sheetsにデータを書き込む
                scope = ['https://spreadsheets.google.com/feeds',
                        'https://www.googleapis.com/auth/drive']
                creds = ServiceAccountCredentials.from_json_keyfile_name(R'C:\Users\sab78\OneDrive\デスクトップ\不足分印刷\lms-dx-826f9a885b50.json', scope)
                client = gspread.authorize(creds)
                spreadsheet = client.open("ソーター画面の並び順")
                worksheet = spreadsheet.worksheet("URL")

                # A2からA列をクリアしてからA2に新しいデータを記録
                clear_and_update_data(worksheet, batch_info, "A2:A")

    # ブラウザを閉じる
    driver.quit()

if __name__ == "__main__":
    main()
